## Deep dive to Jinja and SQL
![deep-dive-jinja-sql.png](..%2F..%2Fimg%2Fdeep-dive-jinja-sql.png)

–ß—Ç–æ–±—ã –ª–µ–≥—á–µ –≤–∫–∞—Ç–∏—Ç—å—Å—è –≤ –º–∏—Ä dbt, –Ω–∞—á–Ω–µ–º –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å Jinja –ø–æ–±–ª–∏–∂–µ –∏ —Å–¥–µ–ª–∞–µ–º —Å–≤–æ–π –º–∏–Ω–∏-dbt (–Ω—É —Å–æ–≤—Å–µ–º –º–∏–Ω–∏ üòà)

### First SQL

–ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫:
- templates - —Ç—É—Ç —Å–∏–∫–≤–µ–ª —Ñ–∞–π–ª—ã-—à–∞–±–ª–æ–Ω—ã
- scripts - —Ç—É—Ç –∂–∏–≤—É—Ç python —Å–∫—Ä–∏–ø—Ç—ã
- macros - –Ω–∞ –±—É–¥—É—â–µ–µ –¥–ª—è –º–∞–∫—Ä–æ—Å–æ–≤ =)

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è chapter-1 —É —Ç–µ–±—è –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–∞–±–ª–∏—Ü–∞ **stg.kinopoisk**. –î–ª—è –Ω–∞—Å –æ–Ω–∞ –±—É–¥–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –¥–∞–Ω–Ω—ã—Ö:

```sql
SELECT * FROM stg.kinopoisk; 
```

1. –¢—Ä–µ–Ω–∏—Ä—É–µ–º—Å—è –Ω–∞ –∫–æ—à–µ—á–∫–∞—Ö

–°–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω: –ø—Ä–æ—Å—Ç–æ–π SELECT c —É—Å–ª–æ–≤–∏—è–º–∏, –ø–æ–ø—Ä–æ–±—É–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –≥–æ–¥—É –∏ —Å—Ç—Ä–∞–Ω–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–∫–æ–π [where-clause.sql](template%2Fwhere-clause.sql)

```sql
SELECT * FROM stg.kinopoisk
WHERE production_year = '{{ year }}'
AND country = '{{ country }}'; 
```

–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ:
![escape-strings-param.png](..%2F..%2Fimg%2Fescape-strings-param.png)


–ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ä–∞–±–æ—Ç–∫–∏ –∏–∑ chapter-2 –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL -> [main.py](scripts%2Fmain.py):

```python
if __name__ == "__main__":
    stmt = get_rendered_template("../templates",
                                 "where-clause.sql",
                                 year="2020",
                                 country="–°–®–ê")

    print(stmt)
```

–ü–µ—Ä–µ–¥–∞—ë–º –Ω–∞—à–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –ø–æ–ª—É—á–∞–µ–º –≤—ã—Ö–æ–¥–Ω–æ–π SQL-—Å–∫—Ä–∏–ø—Ç:

```sql
SELECT * FROM stg.kinopoisk
WHERE production_year = '2020'
AND country = '–°–®–ê'
```

–ò–¥–µ–º –ø—Ä–æ–≤–µ—Ä–∏–º: –æ—à–∏–±–æ–∫ –Ω–µ—Ç, –ø–æ–ª—É—á–∏–ª–∏ —Ç–æ–ª—å–∫–æ 2020 –≥–æ–¥ –∏ –°–®–ê:
![where-clause.png](img%2Fwhere-clause.png)


2. Research data

–î–∞–≤–∞–π –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∏–∑—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ: –ø–æ—Å–º–æ—Ç—Ä–∏–º —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∫–∞–∫ –∑–∞–ø–∏—Å–∞–Ω—ã —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –ø–æ–ª—è (—Å—Ç—Ä–∞–Ω–∞, –∂–∞–Ω—Ä, —Ä–µ–∂–∏—Å—Å–µ—Ä, –±—é–¥–∂–µ—Ç –∏ —Å–±–æ—Ä—ã –∏ –¥—Ä).

–¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ö–∏—Ç—Ä—ã–º –∑–∞–ø—Ä–æ—Å–æ–º:

```sql
SELECT column_name,
      data_type
FROM information_schema.COLUMNS
WHERE ![img.png](img.png)table_name = 'kinopoisk';
```

–í—Å–µ –ø–æ–ª—è —É –Ω–∞—Å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ, –∫—Ä–æ–º–µ **rating_kp_top** (–µ–º—É –ø–æ–≤–µ–∑–ª–æ).

–û—Ç–º–µ—á–∞–µ–º:
- –∂–∞–Ω—Ä–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ - —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –Ω–∏–∂–Ω–∏–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ–º
- —Å—Ç—Ä–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ - —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –Ω–∏–∂–Ω–∏–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ–º
- –±—é–¥–∂–µ—Ç —É–∫–∞–∑–∞–Ω –≤ –¥–µ–Ω–µ–∂–Ω—ã–º –µ–¥–∏–Ω–∏—Ü–∞—Ö
- —Ä–µ–π—Ç–∏–Ω–≥ IMDb –∏–º–µ–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å

![research.png](img%2Fresearch.png)

–ö–∞–∫ –º–∏–Ω–∏–º—É–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–∞–ª–µ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ–≤–æ–ª—å–Ω–æ –º–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π - —ç—Ç–∏–º –º—ã –∑–∞–π–º–µ–º—Å—è, –Ω–æ —á—É—Ç—å –ø–æ–∑–∂–µ.

–ê –ø–æ–∫–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –µ—â–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π jinja, –Ω–∞ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `set` –∏ `for` - —É –Ω–∞—Å –∑–∞–¥–∞—á–∞, –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞–±–æ—Ä–∞
–≥–æ–¥–æ–≤ –ø–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª-–≤–æ –≤—ã–ø—É—â–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤ (–¥–∞, —ç—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∏ –ø–æ–º–æ—â–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏, –Ω–æ —Ç—ã –∂–µ –∏–¥–µ—à—å –≤ –≥–æ—Ä—É, –∞ –Ω–µ –≤ –æ–±—Ö–æ–¥, –≤–µ—Ä–Ω–æüòú)

3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∫–æ–π-–ª–∏–±–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (if/for/set –∏ –¥—Ä) –≤–Ω—É—Ç—Ä–∏ jinja –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å `{%  %}`, —á—Ç–æ–±—ã
–∑–∞–¥–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —É–∫–∞–∑—ã–≤–∞–µ–º: `{% set my_var = 'Hello, Jinja2!'%}`

C–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —à–∞–±–ª–æ–Ω :

```sql
{% set my_var = 'Hello, Jinja2!'%}
SELECT '{{ my_var }}' as external_name,
      now() as dt;
```

–ó–∞–ø—É—Å–∫–∞–µ–º –∏ –≤—É–∞–ª—è:

```sql
SELECT 'Hello, Jinja2!' as external_name,
      now() as dt;
```