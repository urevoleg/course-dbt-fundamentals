# –í–∏—Ç—Ä–∏–Ω–∞

![de-datamarts.png](img%2Fde-datamarts.png)

–ü–µ—Ä–µ–¥ —ç—Ç–æ–π –≥–ª–∞–≤–æ–π —Ç—ã –∂–µ –ø–æ—Ç—Ä–µ–Ω–∏–ª: —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –º–∞–∫—Ä–æ—Å—ã ü§®

–ü–æ—ç—Ç–æ–º—É –µ—â–µ –Ω–µ–±–æ–ª—å—à–æ–π –º–∞–∫—Ä–æ—Å, —á—Ç–æ–±—ã –≤—Å—ë –ø–æ-–≤–∑—Ä–æ—Å–ª–æ–º—É –±—ã–ª–æ:

```sql
{% macro ref(name) -%}
dds.{{name}}
{% endmacro %}
```

–ß—Ç–æ–±—ã –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑ —Å—Ö–µ–º—É, –≤–µ–¥—å –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–ª–æ–µ `dds`.

–°–æ–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –≤–∏—Ç—Ä–∏–Ω—É: –í —Ä–∞–∑—Ä–µ–∑–µ –≥–æ–¥–æ–≤, —Å—Ç—Ä–∞–Ω, –∂–∞–Ω—Ä–æ–≤ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å:
- –∫–æ–ª-–≤–æ —Ñ–∏–ª—å–º–æ–≤
- —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥
- —Å—Ä–µ–¥–Ω–∏–π –±—é–¥–∂–µ—Ç
- —Å—Ä–µ–¥–Ω–∏–µ —Å–±–æ—Ä—ã –≤ –°–®–ê
- —Å—Ä–µ–¥–Ω—é—é –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å - `sum(box_office) / sum(buget) - 1`

–ü–∏—à–µ–º SQL –∫–æ–¥:

```sql
SELECT production_year, 
       country, 
       genre,
       count(1) as cnt,
       avg(imdb) as avg_imdb,
       avg(budget) as avg_budget,
       sum(box_office_usa) / sum(budget) - 1 as profit
FROM dds.raw_kp
GROUP BY production_year, country, genre
ORDER BY production_year
```

–î–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏—Ç—Ä–∏–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
- –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∏—Ç—Ä–∏–Ω—ã
- –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥: –∫–∞–∫–æ–π —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

